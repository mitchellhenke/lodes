---

stages:
  fetch_lodes_by_state:
    matrix:
      year: ${input.year}
      state: ${input.state}
    cmd: "Rscript ./src/download_lodes.R ${item.year} ${item.state}"
    outs:
      - ./input/lodes/year=${item.year}/state=${item.state}/${item.state}.csv.gz:
          persist: true
  build_lodes_by_tract:
    deps:
      - ./input/lodes/year=${item.year}/state=${item.state}/${item.state}.csv.gz
    matrix:
      year: ${input.year}
      state: ${input.state}
    cmd: "Rscript ./src/aggregate_lodes.R ${item.year} ${item.state} tract"
    outs:
      - ./intermediate/od_tract/year=${item.year}/state=${item.state}/${item.state}.parquet:
          persist: true
